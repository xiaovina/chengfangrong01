<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>EOS Analizy tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" media="screen" href="css/bootstrap.min.css" />
  <script src="js/jquery.min.js"></script>
</head>
<body class="container">
  <h2>EOS Analizy tool</h2>
  <div class="row">
    <div class="col-sm-2">
      期号：<span id="newestGameId" style="color:blue;">-</span>
    </div>
    <div class="col-sm-2">
      目前连<span id="nonstopDaXiao" style="color: red"></span><span id="nonstopDaXiaoTimes" style="color: red"></span>次;
    </div>
    <div class="col-sm-2">
      目前连<span id="nonstopDanShuang" style="color: red"></span><span id="nonstopDanShuangTimes"  style="color: red"></span>次;
    </div>
    <div class="col-sm-6" id="allProbability" style="height: 92px;">
      下一注投大中奖概率：所有时间平均：<span id="allProbability-0" style="color: red">-</span>%; <br/>
      下一注投小中奖概率：所有时间平均：<span id="allProbability-1" style="color: red">-</span>%; <br/>
      下一注投单中奖概率：所有时间平均：<span id="allProbability-2" style="color: red">-</span>%; <br/>
      下一注投双中奖概率：所有时间平均：<span id="allProbability-3" style="color: red">-</span>%; <br/>
    </div>
  </div>
  <hr/>

  <div class="row" style="margin-top: 20px;">
    <div class="form-group col-sm-12">
      <label class="radio-inline col-sm-2">
          <input type="radio" name="optionsRadiosFirb" id="optionsRadios2" value="2"> 2小时
      </label>
      <label class="radio-inline col-sm-2">
          <input type="radio" name="optionsRadiosFirb" id="optionsRadios5" value="5"> 5小时
      </label>
      <label class="radio-inline col-sm-2">
          <input type="radio" name="optionsRadiosFirb" id="optionsRadios8" value="8"> 8小时
      </label>
      <label class="radio-inline col-sm-2">
          <input type="radio" name="optionsRadiosFirb" id="optionsRadios13" value="13"> 13小时
      </label>
      <label class="radio-inline col-sm-2">
          <input type="radio" name="optionsRadiosFirb" id="optionsRadios21" value="21"> 21小时
      </label>
    </div>
    <div class="form-group col-sm-12">
      <label class="radio-inline col-sm-2">
          <input type="radio" name="optionsRadiosFirb" id="optionsRadios34" value="34"> 34小时
      </label>
      <label class="radio-inline col-sm-2">
          <input type="radio" name="optionsRadiosFirb" id="optionsRadios55" value="55"> 55小时
      </label>
      <label class="radio-inline col-sm-2">
          <input type="radio" name="optionsRadiosFirb" id="optionsRadios89" value="89"> 89小时
      </label>
      <label class="radio-inline col-sm-2">
          <input type="radio" name="optionsRadiosFirb" id="optionsRadios144" value="144"> 144小时
      </label>
      <label class="radio-inline col-sm-2">
          <input type="radio" name="optionsRadiosFirb" id="optionsRadios233" value="233"> 233小时
      </label>
    </div>
    <div class="form-group col-sm-12">
      <div class="form-group col-sm-2">
        <button type="button" class="btn btn-primary" onclick="doSliceAnalizy()">分析</button>
      </div>
      <div class="form-group col-sm-8" id="sliceProbability" style="height: 92px;"></div>
        <!-- <span id="slice" style="color: red">-</span>小时总中奖概率<span id="sliceProbability" style="color: red">-</span>%;<br/> -->
      </div>
    </div>
  </div>
</body>
<script>


$(function(){
  console.log('init');
  getNonstop();

  var data = dealLocalStorage("get");
  if (data && data.privateKey && data.actor) {
    $("#privateKey").val(data.privateKey);
    $("#actor").val(data.actor);
  }
})

function _sleep(milliseconds) {
  return new Promise(resolve => setTimeout(resolve, milliseconds))
}

function doTransfer() {
  var privateKey = $("#privateKey").val();
  console.log(privateKey);
  var actor = $("#actor").val();
  console.log(actor);
  var quantity = $("#quantity").val();
  console.log(quantity);
  var optionsRadiosDaxiao = $("input[name=optionsRadiosDaxiao]:checked").val();
  console.log(optionsRadiosDaxiao);
  var optionsRadiosDanShuang = $("input[name=optionsRadiosDanShuang]:checked").val();
  console.log(optionsRadiosDanShuang);

  var flag = true;
  if (!privateKey || privateKey.length != 51) {
    flag = false;
  }
  if (!actor || actor.length != 12) {
    flag = false;
  }
  if (!quantity || quantity < 0.0001 || quantity > 100) {
    flag = false;
  }
  if(!optionsRadiosDaxiao && !optionsRadiosDanShuang) {
    flag = false;
  }

  let data = {
    privateKey,
    actor,
    quantity
  }
  if (flag) {
    dealLocalStorage("set", data);
    $("#transferResult").html('投注中...');
    if (optionsRadiosDaxiao) {
      data.daxiaodanshuang = optionsRadiosDaxiao
      postTransfer(data);
    }

    if (optionsRadiosDanShuang) {
      data.daxiaodanshuang = optionsRadiosDanShuang
      postTransfer(data);
    }
  } else {
    $("#transferResult").html('请检查投注参数是否正确填写！');
  }
}

function postTransfer(data) {
  $.ajax({
      url: `/api/v1/lottery/eos/transfer`,
      method: 'post',
      data: data
    }).done(function(res) {
      console.log(res);
      $("#transferResult").html('');
      if (res && res.transaction_id) {
        $("#transferResult").append(`投注成功，交易ID为：${res.transaction_id}`);
      } else {
        $("#transferResult").append("投注失败，请检查eosplay网站，再重试。");
      }
    });
}

function getNonstop() {
  $("#nonstopDaXiao").html('...')
  $("#nonstopDaXiaoTimes").html('...')
  $("#nonstopDanShuang").html('...')
  $("#nonstopDanShuangTimes").html('...')

  getAllProbability();
  getNewestGameId();
  $.ajax({
      url: `/api/v1/lottery/analizy/nonstop`,
      method: 'get',
    }).done(function(res) {
      console.log(res);
      $("#transferResult").html('');
      if (res && res.length === 2) {
        $("#nonstopDaXiao").html(res[0].daxiaodanshaung)
        $("#nonstopDaXiaoTimes").html(res[0].nonstopCount)
        $("#nonstopDanShuang").html(res[1].daxiaodanshaung)
        $("#nonstopDanShuangTimes").html(res[1].nonstopCount)

        _sleep(2000).then(() => {
          getNonstop();
        })
      }
    });
}

function getNewestGameId() {
  $.ajax({
      url: `/api/v1/lottery/eos/newest`,
      method: 'get',
    }).done(function(res) {
      console.log(res);
      $(`#newestGameId`).html(res[0].gameid);
    });
}

function getAllProbability() {
  $.ajax({
      url: `/api/v1/lottery/probability/all`,
      method: 'get',
    }).done(function(res) {
      console.log(res);
      if (res && res.length > 0) {
        for (let r in res) {
          console.log(r)
          $(`#allProbability-${r}`).html(res[r].p);
        }
      }
    });
}

function doSliceAnalizy() {
  var optionsRadiosFirb = $("input[name=optionsRadiosFirb]:checked").val();
  console.log(optionsRadiosFirb);

  if (!optionsRadiosFirb) {
    alert('请选择小时数！');
    return;
  } else {
    var limit = _sliceMapping(optionsRadiosFirb);

    $("#sliceProbability").html('');
    $.ajax({
      url: `/api/v1/lottery/probability/slice/dxds?slice=${optionsRadiosFirb}`,
      method: 'get',
    }).done(function(res) {
      console.log(res);
      if (res && res.length > 0) {
          for (let r of res) {
            console.log(r);
            $("#sliceProbability").append(`<span style="color: red">${optionsRadiosFirb}</span>小时投注${r.dxds}的中奖概率<span id="sliceProbability" style="color: red">${r.p}</span>%;<br/>`);
          }
      }
    });
  }
}

function dealLocalStorage(type, data = null) {
  if (type === "set") {
    console.log(data)
    localStorage.setItem("secret", JSON.stringify(data));
  } else {
    const secret = localStorage.getItem("secret");
    console.log(secret)

    if (secret) {
      return JSON.parse(secret);
    } else {
      return null;
    }
  }
}

function _sliceMapping(slice) {
    slice = Number(slice);
    if (slice ===2) {
      return 2;
    }
    if (slice ===5) {
      return 3;
    }
    if (slice ===8) {
      return 3;
    }
    if (slice ===13) {
      return 4;
    }
    if (slice ===21) {
      return 4;
    }
    if (slice ===34) {
      return 5;
    }
    if (slice ===55) {
      return 5;
    }
    if (slice ===89) {
      return 6;
    }
    if (slice ===144) {
      return 8;
    }
    if (slice ===233) {
      return 9;
    }
  }
</script>
</html>
